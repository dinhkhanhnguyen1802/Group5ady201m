import pandas as pd
from datetime import datetime, timedelta
from vnstock import Vnstock
from sqlalchemy import create_engine
import matplotlib.pyplot as plt
import matplotlib.dates as mdates

def get_stock_data(symbol="FPT", days=1825):
    """
    L·∫•y d·ªØ li·ªáu c·ªï phi·∫øu t·ª´ vnstock3 trong kho·∫£ng N ng√†y g·∫ßn nh·∫•t
    """
    end = datetime.today().strftime("%Y-%m-%d")
    start = (datetime.today() - timedelta(days=days)).strftime("%Y-%m-%d")
    
    fpt = Vnstock().stock(symbol=symbol, source="VCI")
    df = fpt.quote.history(start=start, end=end)
    
    if df.empty:
        print("‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu.")
        return pd.DataFrame()
    
    date_col = "time" if "time" in df.columns else "date"
    df[date_col] = pd.to_datetime(df[date_col])
    df = df.rename(columns={date_col: "date"})
    df = df.sort_values("date")
    
    return df

def save_to_sql(df):
    """
    C·∫≠p nh·∫≠t d·ªØ li·ªáu ng√†y m·ªõi nh·∫•t v√†o SQL Server
    """
    try:
        engine = create_engine(
            "mssql+pyodbc://sa:123456@localhost\\SQLEXPRESS/FPT_StockDB"
            "?driver=ODBC+Driver+18+for+SQL+Server&TrustServerCertificate=yes",
            fast_executemany=True
        )

        # ƒê·ªçc d·ªØ li·ªáu hi·ªán c√≥ (n·∫øu b·∫£ng ƒë√£ t·ªìn t·∫°i)
        existing = pd.read_sql("SELECT date FROM dbo.FPT_Stock", con=engine)
        existing['date'] = pd.to_datetime(existing['date'])

        # L·ªçc ra c√°c ng√†y ch∆∞a c√≥ trong SQL
        new_data = df[~df['date'].isin(existing['date'])]

        if new_data.empty:
            print("‚úÖ D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t, kh√¥ng c√≥ g√¨ m·ªõi.")
            return

        # Ghi th√™m d·ªØ li·ªáu m·ªõi (append)
        new_data.to_sql("FPT_Stock", con=engine, schema="dbo",
                        if_exists="append", index=False, method="multi", chunksize=1000)
        print(f"‚úÖ ƒê√£ th√™m {len(new_data)} d√≤ng d·ªØ li·ªáu m·ªõi v√†o SQL Server!")

    except Exception as e:
        # N·∫øu b·∫£ng ch∆∞a t·ªìn t·∫°i, t·∫°o m·ªõi
        if "FPT_Stock" in str(e):
            df.to_sql("FPT_Stock", con=engine, schema="dbo",
                      if_exists="replace", index=False, method="multi", chunksize=1000)
            print("‚öôÔ∏è B·∫£ng m·ªõi ƒë∆∞·ª£c t·∫°o trong SQL Server!")
        else:
            print("‚ùå L·ªói khi ghi d·ªØ li·ªáu v√†o SQL:", e)

def plot_stock_data(df):
    """
    V·∫Ω bi·ªÉu ƒë·ªì gi√° c·ªï phi·∫øu
    """
    if df.empty:
        print("‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì.")
        return
    
    # T·∫°o figure v·ªõi 2 subplot
    fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(12, 10))
    
    # Bi·ªÉu ƒë·ªì 1: Gi√° ƒë√≥ng c·ª≠a
    ax1.plot(df['date'], df['close'], linewidth=2, color='blue', label='Gi√° ƒë√≥ng c·ª≠a')
    ax1.set_title('üìà BI·ªÇU ƒê·ªí GI√Å C·ªî PHI·∫æU FPT', fontsize=14, fontweight='bold')
    ax1.set_ylabel('Gi√° (VND)', fontsize=12)
    ax1.legend()
    ax1.grid(True, alpha=0.3)
    
    # ƒê·ªãnh d·∫°ng tr·ª•c x cho bi·ªÉu ƒë·ªì gi√°
    ax1.xaxis.set_major_formatter(mdates.DateFormatter('%Y-%m'))
    ax1.xaxis.set_major_locator(mdates.MonthLocator(interval=3))
    
    # Bi·ªÉu ƒë·ªì 2: Kh·ªëi l∆∞·ª£ng giao d·ªãch
    ax2.bar(df['date'], df['volume'], color='orange', alpha=0.7, label='Kh·ªëi l∆∞·ª£ng')
    ax2.set_title('üìä KH·ªêI L∆Ø·ª¢NG GIAO D·ªäCH', fontsize=12, fontweight='bold')
    ax2.set_xlabel('Th·ªùi gian', fontsize=12)
    ax2.set_ylabel('Kh·ªëi l∆∞·ª£ng', fontsize=12)
    ax2.legend()
    ax2.grid(True, alpha=0.3)
    
    # ƒê·ªãnh d·∫°ng tr·ª•c x cho bi·ªÉu ƒë·ªì kh·ªëi l∆∞·ª£ng
    ax2.xaxis.set_major_formatter(mdates.DateFormatter('%Y-%m'))
    ax2.xaxis.set_major_locator(mdates.MonthLocator(interval=3))
    
    # T·ª± ƒë·ªông xoay nh√£n tr·ª•c x
    plt.gcf().autofmt_xdate()
    
    # Hi·ªÉn th·ªã bi·ªÉu ƒë·ªì
    plt.tight_layout()
    plt.show()
    
    # V·∫Ω th√™m bi·ªÉu ƒë·ªì n·∫øn (OHLC) cho 60 ng√†y g·∫ßn nh·∫•t
    plot_candlestick(df.tail(60))

def plot_candlestick(df):
    """
    V·∫Ω bi·ªÉu ƒë·ªì n·∫øn (candlestick) cho d·ªØ li·ªáu g·∫ßn nh·∫•t
    """
    if len(df) < 2:
        print("‚ùå Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì n·∫øn.")
        return
    
    try:
        from mplfinance.original_flavor import candlestick_ohlc
        import matplotlib.dates as mdates
        
        # Chu·∫©n b·ªã d·ªØ li·ªáu cho bi·ªÉu ƒë·ªì n·∫øn
        df_ohlc = df[['date', 'open', 'high', 'low', 'close', 'volume']].copy()
        df_ohlc['date'] = mdates.date2num(df_ohlc['date'])
        
        # T·∫°o figure
        fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(12, 8))
        
        # V·∫Ω bi·ªÉu ƒë·ªì n·∫øn
        candlestick_ohlc(ax1, df_ohlc.values, width=0.6, colorup='g', colordown='r', alpha=0.8)
        ax1.set_title('üïØÔ∏è BI·ªÇU ƒê·ªí N·∫æN FPT (60 ng√†y g·∫ßn nh·∫•t)', fontsize=14, fontweight='bold')
        ax1.set_ylabel('Gi√° (VND)', fontsize=12)
        ax1.grid(True, alpha=0.3)
        
        # ƒê·ªãnh d·∫°ng tr·ª•c x
        ax1.xaxis.set_major_formatter(mdates.DateFormatter('%Y-%m-%d'))
        ax1.xaxis.set_major_locator(mdates.WeekdayLocator(interval=2))
        
        # Bi·ªÉu ƒë·ªì kh·ªëi l∆∞·ª£ng
        ax2.bar(df['date'], df['volume'], color='orange', alpha=0.7)
        ax2.set_title('Kh·ªëi l∆∞·ª£ng giao d·ªãch', fontsize=12)
        ax2.set_xlabel('Ng√†y', fontsize=12)
        ax2.set_ylabel('Kh·ªëi l∆∞·ª£ng', fontsize=12)
        ax2.grid(True, alpha=0.3)
        
        # ƒê·ªãnh d·∫°ng tr·ª•c x
        ax2.xaxis.set_major_formatter(mdates.DateFormatter('%Y-%m-%d'))
        ax2.xaxis.set_major_locator(mdates.WeekdayLocator(interval=2))
        
        plt.gcf().autofmt_xdate()
        plt.tight_layout()
        plt.show()
        
    except ImportError:
        print("‚ö†Ô∏è  Kh√¥ng th·ªÉ v·∫Ω bi·ªÉu ƒë·ªì n·∫øn. C√†i ƒë·∫∑t: pip install mplfinance")

def display_stock_analysis(df):
    """
    Hi·ªÉn th·ªã dashboard ph√¢n t√≠ch d·ªØ li·ªáu c·ªï phi·∫øu
    """
    print("üöÄ PH√ÇN T√çCH C·ªî PHI·∫æU FPT")
    print("=" * 50)

    if df.empty:
        print("‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch.")
        return

    # T√≠nh to√°n metrics
    current_price = df['close'].iloc[-1]
    price_change = df['close'].iloc[-1] - df['close'].iloc[-2]
    percent_change = (price_change / df['close'].iloc[-2]) * 100
    avg_volume = df['volume'].mean()
    
    # Th√™m c√°c ch·ªâ s·ªë kh√°c
    max_price = df['close'].max()
    min_price = df['close'].min()
    volatility = df['close'].pct_change().std() * 100  # ƒê·ªô bi·∫øn ƒë·ªông (%)
    
    print(f"üìä Gi√° hi·ªán t·∫°i: {current_price:,.0f} VND")
    print(f"üìà Thay ƒë·ªïi: {price_change:+,.0f} VND ({percent_change:+.2f}%)")
    print(f"üì¶ Kh·ªëi l∆∞·ª£ng TB: {avg_volume:,.0f}")
    print(f"üéØ Gi√° cao nh·∫•t: {max_price:,.0f} VND")
    print(f"üîª Gi√° th·∫•p nh·∫•t: {min_price:,.0f} VND")
    print(f"üåä ƒê·ªô bi·∫øn ƒë·ªông: {volatility:.2f}%")
    print(f"üìÖ S·ªë ng√†y d·ªØ li·ªáu: {len(df)}")
    print("=" * 50)

    # B·∫£ng d·ªØ li·ªáu
    print("\nüìã D·ªÆ LI·ªÜU CHI TI·∫æT (10 ng√†y g·∫ßn nh·∫•t):")
    df_show = df.tail(10).copy()
    df_show['date'] = df_show['date'].dt.strftime('%d/%m/%Y')
    for col in ['open', 'high', 'low', 'close']:
        df_show[col] = df_show[col].apply(lambda x: f"{x:,.0f}")
    df_show['volume'] = df_show['volume'].apply(lambda x: f"{x:,.0f}")
    print(df_show.to_string(index=False))

# ------------------------- MAIN -------------------------
if __name__ == "__main__":
    df = get_stock_data(symbol="FPT", days=1825)
    
    if not df.empty:
        display_stock_analysis(df)
        plot_stock_data(df)  # Th√™m bi·ªÉu ƒë·ªì
        save_to_sql(df)
