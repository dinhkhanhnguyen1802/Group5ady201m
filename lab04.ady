import pandas as pd
from datetime import datetime, timedelta
from vnstock import Vnstock
from sqlalchemy import create_engine, text

# ==== Káº¾T Ná»I DB ====
def get_engine():
    return create_engine(
        "mssql+pyodbc://sa:123456@localhost\\SQLEXPRESS/FPT_StockDB"
        "?driver=ODBC+Driver+18+for+SQL+Server&TrustServerCertificate=yes",
        fast_executemany=True
    )

# ==== Láº¤Y Dá»® LIá»†U ====
def get_stock_data_range(symbol, start, end):
    f = Vnstock().stock(symbol=symbol, source="VCI")
    df = f.quote.history(start=start, end=end)  # tráº£ vá» DataFrame ngÃ y
    if df.empty:
        return pd.DataFrame()
    date_col = "time" if "time" in df.columns else "date"
    df = df.rename(columns={date_col: "date"})
    df["date"] = pd.to_datetime(df["date"])
    df = df.sort_values("date").reset_index(drop=True)
    return df

# ==== TRUY Váº¤N DB ====
def get_max_date_in_db(engine, table="FPT_Stock"):
    try:
        with engine.connect() as conn:
            max_d = conn.execute(text(f"SELECT MAX([date]) FROM {table}")).scalar()
        return pd.to_datetime(max_d) if max_d else None
    except Exception:
        # báº£ng chÆ°a tá»“n táº¡i
        return None

def replace_overlap_and_append(engine, df_new, table="FPT_Stock", cutoff_date=None):
    # xÃ³a pháº§n chá»“ng láº¥n rá»“i append
    with engine.begin() as conn:
        if cutoff_date is not None:
            conn.execute(
                text(f"DELETE FROM {table} WHERE [date] >= :d"), {"d": cutoff_date}
            )
    df_new.to_sql(table, con=engine, if_exists="append", index=False)

# ==== HIá»‚N THá»Š NGÃ€Y Má»šI NHáº¤T ====
def display_latest_from_db(engine, table="FPT_Stock"):
    # Láº¥y 2 dÃ²ng má»›i nháº¥t Ä‘á»ƒ tÃ­nh % thay Ä‘á»•i
    q = f"SELECT TOP 2 * FROM {table} ORDER BY [date] DESC"
    df = pd.read_sql(q, con=engine)
    if df.empty:
        print("âŒ ChÆ°a cÃ³ dá»¯ liá»‡u trong DB.")
        return
    df["date"] = pd.to_datetime(df["date"])
    df = df.sort_values("date")  # nhá» -> lá»›n Ä‘á»ƒ láº¥y 2 dÃ²ng cuá»‘i
    latest = df.iloc[-1]
    prev = df.iloc[-2] if len(df) > 1 else None

    current_price = latest["close"]
    if prev is not None:
        price_change = current_price - prev["close"]
        percent_change = price_change / prev["close"] * 100
    else:
        price_change = 0
        percent_change = 0.0

    print("ğŸš€ PHÃ‚N TÃCH Cá»” PHIáº¾U FPT (ngÃ y gáº§n nháº¥t)")
    print("=" * 50)
    print(f"ğŸ“… NgÃ y: {latest['date'].strftime('%d/%m/%Y')}")
    print(f"ğŸ“Š GiÃ¡ Ä‘Ã³ng cá»­a: {current_price:,.0f} VND")
    print(f"ğŸ“ˆ Thay Ä‘á»•i: {price_change:+,.0f} VND ({percent_change:+.2f}%)")
    print(f"ğŸ”¼ Cao nháº¥t: {latest['high']:,.0f} | ğŸ”½ Tháº¥p nháº¥t: {latest['low']:,.0f}")
    print(f"ğŸ“¦ Khá»‘i lÆ°á»£ng: {latest['volume']:,.0f}")
    print("=" * 50)

# ==== MAIN: CHá»ˆ Cáº¬P NHáº¬T PHáº¦N Má»šI ====
if __name__ == "__main__":
    symbol = "FPT"
    today = datetime.today().strftime("%Y-%m-%d")

    engine = get_engine()
    last_date = get_max_date_in_db(engine)

    if last_date is None:
        # Láº§n Ä‘áº§u: táº£i 5 nÄƒm
        start = (datetime.today() - timedelta(days=1825)).strftime("%Y-%m-%d")
        df_full = get_stock_data_range(symbol, start, today)
        if df_full.empty:
            print("âŒ KhÃ´ng cÃ³ dá»¯ liá»‡u.")
        else:
            # táº¡o má»›i toÃ n bá»™
            df_full.to_sql("FPT_Stock", con=engine, if_exists="replace", index=False)
            print(f"âœ… Khá»Ÿi táº¡o báº£ng vá»›i {len(df_full):,} dÃ²ng.")
    else:
        # CÃ¡c láº§n sau: chá»‰ láº¥y tá»« last_date lÃ¹i 5 ngÃ y Ä‘á»ƒ ghi Ä‘Ã¨
        overlap_days = 5
        start = (last_date - timedelta(days=overlap_days)).strftime("%Y-%m-%d")
        df_inc = get_stock_data_range(symbol, start, today)
        if df_inc.empty:
            print("â„¹ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u má»›i.")
        else:
            replace_overlap_and_append(engine, df_inc, cutoff_date=start)
            print(f"âœ… Cáº­p nháº­t {len(df_inc):,} dÃ²ng má»›i/ghi Ä‘Ã¨ pháº§n chá»“ng láº¥n tá»« {start}.")

    # In ra ngÃ y gáº§n nháº¥t (khÃ´ng cáº§n load 5 nÄƒm)
    display_latest_from_db(engine)

summary = {
    "Sá»‘ dÃ²ng": len(df),
    "Sá»‘ cá»™t": df.shape[1],
}
if "date" in df.columns:
    summary.update({
        "Tá»« ngÃ y": df["date"].min(),
        "Äáº¿n ngÃ y": df["date"].max(),
        "ÄÃ£ sáº¯p xáº¿p theo ngÃ y": bool(df["date"].is_monotonic_increasing),
    })
pd.Series(summary)

# Báº£ng type cá»§a tá»«ng cá»™t
dtype_df = pd.DataFrame({
    "column": df.columns,
    "dtype": df.dtypes.astype(str).values,
    "n_unique": [df[c].nunique(dropna=True) for c in df.columns],
})
dtype_df


